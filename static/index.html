<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>University Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-indigo-600 text-white p-4 shadow-md">
    <h1 class="text-xl font-bold">üéì University Assistant</h1>
    <p class="text-sm text-indigo-200">Ask questions about any university page</p>
  </header>

  <!-- Chat Container -->
  <main id="chat" class="flex-1 overflow-y-auto p-4 space-y-4">
    <!-- Messages will be appended here -->
  </main>

  <!-- Input Area -->
  <footer class="p-4 bg-white shadow-inner">
    <form id="ask-form" class="flex space-x-2">
      <input
        type="text"
        id="url"
        placeholder="Paste a website link (first time only)"
        class="flex-1 rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
      />
      <input
        type="text"
        id="question"
        placeholder="Ask your question..."
        class="flex-1 rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
        required
      />
      <button
        type="submit"
        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700"
      >
        Ask
      </button>
    </form>
  </footer>

  <script>
    const chat = document.getElementById("chat");
    const form = document.getElementById("ask-form");
    const urlInput = document.getElementById("url");
    const qInput = document.getElementById("question");

    function addMessage(role, text) {
      const wrapper = document.createElement("div");
      wrapper.className = role === "user"
        ? "text-right"
        : "text-left";

      const bubble = document.createElement("div");
      bubble.className =
        (role === "user"
          ? "bg-indigo-600 text-white ml-auto"
          : "bg-gray-200 text-gray-800 mr-auto") +
        " max-w-xl inline-block px-4 py-2 rounded-2xl shadow";

      bubble.innerHTML = text.replace(/\n/g, "<br>");
      wrapper.appendChild(bubble);
      chat.appendChild(wrapper);
      chat.scrollTop = chat.scrollHeight;
    }

    async function callAPI(url, question) {
      addMessage("user", question);
      const loadingId = "loading-" + Date.now();
      addMessage("assistant", `<span id="${loadingId}">‚è≥ Working‚Ä¶</span>`);

      try {
        const resp = await fetch("/api/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            question,
            start_url: url || undefined,
            depth: 3,
            max_pages: 200,
          }),
        });
        const data = await resp.json();

        // Replace loading text with real answer
        document.getElementById(loadingId).parentElement.remove();
        addMessage("assistant", data.answer);

        if (data.sources && data.sources.length) {
          addMessage(
            "assistant",
            "üîó <b>Sources:</b><br>" +
              data.sources.map((s) => `<a href="${s}" target="_blank" class="text-indigo-600 underline">${s}</a>`).join("<br>")
          );
        }
      } catch (err) {
        document.getElementById(loadingId).innerText = "‚ùå Error: " + err;
      }
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const url = urlInput.value.trim();
      const q = qInput.value.trim();
      if (!q) return;
      callAPI(url, q);
      qInput.value = "";
    });
  </script>
</body>
</html>
