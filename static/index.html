<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ask from any link or file</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-indigo-700 text-white">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-lg bg-white/10 grid place-items-center text-lg">UKE</div>
        <div>
          <h1 class="font-semibold text-lg">SCRAPER</h1>
          <p class="text-indigo-200 text-sm">Index links and/or upload files—then get precise answers with sources.</p>
        </div>
      </div>
      <button id="newSessionBtn" class="text-indigo-100 hover:text-white text-sm underline">New session</button>
    </div>
  </header>

  <!-- Session bar -->
  <div class="bg-white border-b">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
      <label class="text-sm text-gray-600">Session:</label>
      <input id="sessionId" class="flex-1 max-w-md rounded-md border px-3 py-1.5 text-sm" placeholder="auto-generated…" />
      <button id="copySessionBtn" class="text-sm text-indigo-700 hover:underline">Copy</button>
      <span id="status" class="ml-auto text-sm text-gray-500"></span>
    </div>
  </div>

  <!-- Banner -->
  <div id="banner" class="hidden mx-auto w-full max-w-5xl px-4">
    <div id="bannerInner" class="mt-3 rounded-md border px-4 py-2 text-sm"></div>
  </div>

  <!-- Content -->
  <main class="max-w-5xl mx-auto w-full px-4 py-6 flex-1">
    <div class="bg-white rounded-xl shadow-sm border">
      <div class="p-4 border-b flex items-center gap-2">
        <div class="h-8 w-8 rounded-md bg-indigo-50 grid place-items-center text-indigo-600 font-semibold">AI</div>
        <div>
          <div class="font-medium">Ask from any link or file</div>
          <div id="errorTop" class="text-sm text-red-600 hidden"></div>
          <div id="hintTop" class="text-sm text-gray-500">Tip: index via the Links tab or just Upload files — uploads are indexed automatically.</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="px-4 pt-4">
        <div class="flex gap-2">
          <button id="tabLinks" class="px-3 py-1.5 rounded-md text-sm bg-indigo-600 text-white">Links</button>
          <button id="tabFiles" class="px-3 py-1.5 rounded-md text-sm text-gray-700 hover:bg-gray-100">Files</button>
        </div>
      </div>

      <!-- Links pane -->
      <section id="paneLinks" class="p-4 space-y-3">
        <textarea id="linksTextarea" rows="6" class="w-full rounded-md border px-3 py-2 text-sm"
          placeholder="Paste one or more URLs…&#10;https://example.com/guide.pdf&#10;https://example.com/page"></textarea>

        <details class="text-sm">
          <summary class="cursor-pointer text-gray-700">Advanced</summary>
          <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-3">
            <label class="flex items-center gap-2">
              <span class="w-28 text-gray-600">Depth</span>
              <input id="depth" type="number" min="0" value="3" class="flex-1 rounded-md border px-3 py-1.5 text-sm">
            </label>
            <label class="flex items-center gap-2">
              <span class="w-28 text-gray-600">Max pages</span>
              <input id="maxPages" type="number" min="1" value="200" class="flex-1 rounded-md border px-3 py-1.5 text-sm">
            </label>
            <label class="flex items-center gap-2 sm:col-span-3">
              <span class="w-28 text-gray-600">Scope prefix</span>
              <input id="scopePrefix" type="text" class="flex-1 rounded-md border px-3 py-1.5 text-sm" placeholder="(optional) e.g., https://domain.tld/path">
            </label>
          </div>
        </details>

        <button id="indexLinksBtn"
          class="inline-flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
          Index links
        </button>
        <span id="linksResult" class="text-sm text-gray-600"></span>
      </section>

      <!-- Files pane -->
      <section id="paneFiles" class="p-4 space-y-3 hidden">
        <input id="fileInput" type="file" multiple
          class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0
                 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
        <p class="text-xs text-gray-500">
          Supported: PDF, HTML/HTM, TXT, MD, DOCX, PPTX (pandoc/LibreOffice needed), and more (backend-dependent).
        </p>
        <p class="text-xs text-gray-600">Files are <b>indexed automatically</b> after you click “Upload files”.</p>

        <button id="uploadBtn"
          class="inline-flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
          Upload files
        </button>
        <span id="filesResult" class="text-sm text-gray-600"></span>
      </section>

      <hr>

      <!-- Ask -->
      <section class="p-4 space-y-3">
        <form id="askForm" class="flex gap-2">
          <input id="question" class="flex-1 rounded-md border px-3 py-2 text-sm" placeholder="Ask your question…" required />
          <button id="askBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Ask</button>
        </form>
        <div id="answerBox" class="prose max-w-none text-gray-800"></div>
        <div id="sourcesBox" class="text-sm text-gray-600 space-y-1"></div>
      </section>
    </div>
  </main>

  <script>
    // ---------- helpers ----------
    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const errorTop = $("errorTop");
    const banner = $("banner");
    const bannerInner = $("bannerInner");
    let indexReady = false; // becomes true after successful index/upload

    function setStatus(msg) { statusEl.textContent = msg || ""; }
    function setError(msg) {
      if (!msg) { errorTop.classList.add("hidden"); errorTop.textContent = ""; return; }
      errorTop.classList.remove("hidden"); errorTop.textContent = msg;
      showBanner(msg, "error", 7000);
    }
    function uuid() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    }
    function ensureSession() {
      let id = $("sessionId").value.trim();
      if (!id) { id = uuid(); $("sessionId").value = id; }
      return id;
    }
    async function fetchJSONSafe(url, init) {
      const res = await fetch(url, init);
      const text = await res.text();
      const ct = res.headers.get("content-type") || "";
      if (ct.includes("application/json")) {
        try { return { ok: res.ok, status: res.status, data: JSON.parse(text), error: null }; }
        catch { return { ok: false, status: res.status, data: null, error: "Invalid JSON from server" }; }
      }
      return { ok: res.ok, status: res.status, data: null, error: text || `HTTP ${res.status}` };
    }
    function escapeHtml(s) { return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    // banner
    let bannerTimer = null;
    function showBanner(message, tone = "ok", autoHideMs = 5000) {
      if (!message) { banner.classList.add("hidden"); bannerInner.textContent = ""; return; }
      let klass = "mt-3 rounded-md border px-4 py-2 text-sm ";
      if (tone === "ok") klass += "bg-green-50 border-green-200 text-green-800";
      else if (tone === "error") klass += "bg-red-50 border-red-200 text-red-800";
      else klass += "bg-yellow-50 border-yellow-200 text-yellow-800";
      bannerInner.className = klass;
      bannerInner.textContent = message;
      banner.classList.remove("hidden");
      if (bannerTimer) clearTimeout(bannerTimer);
      if (autoHideMs > 0) bannerTimer = setTimeout(() => showBanner(""), autoHideMs);
    }

    // tabs
    $("tabLinks").addEventListener("click", () => {
      $("tabLinks").className = "px-3 py-1.5 rounded-md text-sm bg-indigo-600 text-white";
      $("tabFiles").className = "px-3 py-1.5 rounded-md text-sm text-gray-700 hover:bg-gray-100";
      $("paneLinks").classList.remove("hidden");
      $("paneFiles").classList.add("hidden");
    });
    $("tabFiles").addEventListener("click", () => {
      $("tabFiles").className = "px-3 py-1.5 rounded-md text-sm bg-indigo-600 text-white";
      $("tabLinks").className = "px-3 py-1.5 rounded-md text-sm text-gray-700 hover:bg-gray-100";
      $("paneFiles").classList.remove("hidden");
      $("paneLinks").classList.add("hidden");
    });

    // session
    $("newSessionBtn").addEventListener("click", () => {
      $("sessionId").value = uuid();
      indexReady = false;
      setStatus("New session created");
      setError("");
      $("linksResult").textContent = "";
      $("filesResult").textContent = "";
      $("answerBox").innerHTML = "";
      $("sourcesBox").innerHTML = "";
      showBanner("New session created. Add links or upload files to index.", "info", 5000);
    });
    $("copySessionBtn").addEventListener("click", async () => {
      const id = ensureSession();
      await navigator.clipboard.writeText(id);
      setStatus("Session ID copied");
      showBanner("Session ID copied.", "ok", 2500);
    });

    // index links
    $("indexLinksBtn").addEventListener("click", async () => {
      setError("");
      const session_id = ensureSession();
      const urls = $("linksTextarea").value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      if (!urls.length) { setError("Please paste at least one URL."); return; }
      const depth = parseInt($("depth").value || "3", 10);
      const max_pages = parseInt($("maxPages").value || "200", 10);
      const scope_prefix = $("scopePrefix").value.trim() || null;

      setStatus("Indexing links…");
      $("linksResult").textContent = "";

      const { ok, data, error } = await fetchJSONSafe("/api/index_many", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session_id, urls, depth, max_pages, scope_prefix })
      });

      if (!ok) { setError(error || "Index failed"); setStatus(""); return; }
      $("linksResult").textContent =
        `Indexed ${data.pages_indexed ?? data.chunks ?? "?"} pages / ${data.chunks ?? "?"} chunks`;
      indexReady = true;
      setError(""); // hide any previous red text
      setStatus("Done");
      showBanner("Indexing complete — now you can ask your question.", "ok", 6000);
    });

    // upload files (auto-index)
    $("uploadBtn").addEventListener("click", async () => {
      setError("");
      const session_id = ensureSession();
      const files = $("fileInput").files;
      if (!files || !files.length) { setError("Choose one or more files to upload."); return; }

      const form = new FormData();
      form.append("session_id", session_id);
      for (const f of files) form.append("files", f);

      setStatus("Uploading…");
      $("filesResult").textContent = "";

      const { ok, data, error } = await fetchJSONSafe("/api/upload", { method: "POST", body: form });

      if (!ok) { setError(error || "Upload failed"); setStatus(""); return; }
      $("filesResult").textContent =
        `Uploaded ${data.files_processed ?? files.length} file(s), chunks: ${data.chunks ?? "?"}`;
      indexReady = true;
      setError(""); // hide any previous red text
      setStatus("Done");
      showBanner("Indexing complete — now you can ask your question.", "ok", 6000);
    });

    // ask
    $("askForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      setError("");
      const session_id = ensureSession();
      const question = $("question").value.trim();
      if (!question) return;

      $("askBtn").disabled = true;
      $("answerBox").innerHTML = `<div class="text-gray-600">Thinking…</div>`;
      $("sourcesBox").innerHTML = "";

      const { ok, data, error } = await fetchJSONSafe("/api/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session_id, question, top_k: 18, temperature: 0.2 })
      });

      $("askBtn").disabled = false;

      if (!ok) {
        // Special-case the missing-index error with guidance
        if ((error || "").includes("No index for this session")) {
          setError("No index for this session. Index links or upload files, then ask again.");
          showBanner("Please index links or upload files first.", "error", 6000);
        } else {
          setError(error || "Ask failed");
        }
        $("answerBox").innerHTML = "";
        return;
      }

      $("answerBox").innerHTML = (data.answer || "(no answer)")
        .split("\n").map(escapeHtml).join("<br>");

      if (Array.isArray(data.sources) && data.sources.length) {
        $("sourcesBox").innerHTML =
          `<div class="text-gray-800 font-medium">Sources</div>` +
          data.sources.map(s =>
            `<div><a class="text-indigo-700 underline break-all" href="${s}" target="_blank" rel="noreferrer">${escapeHtml(s)}</a></div>`
          ).join("");
      }
    });

    // bootstrap session
    if (!$("sessionId").value) $("sessionId").value = uuid();
  </script>
</body>
</html>
